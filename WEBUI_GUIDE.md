# WebUIユーザーガイド

## 🚀 起動方法

```powershell
uv run streamlit run app.py
```

ブラウザで自動的に開かれます（通常は http://localhost:8501）

## ✨ 主な特徴

### 🎯 自動計算機能（2025-10-14追加）

WebUIは**自動的に次の最適解を計算**するため、快適にプレイできます：

- **手札更新後に自動計算**: 手札を出して山札から追加すると、自動的に次の最適解を計算
- **戦略変更時に即座再計算**: 戦略を変更すると即座に最適解を再計算
- **ボタン操作不要**: 「最適解を分析」ボタンを毎回押す必要はありません

これにより、スムーズで直感的なゲームプレイ体験を実現しています。

---

## 📖 使い方

### 1. ゲーム開始

アプリケーションを起動すると、自動的に新しいゲームが開始されます。

### 2. ゲーム状態の確認

**上部の統計情報**:
- **ターン数**: 現在のターン
- **場に出したカード**: これまでに出したカードの枚数
- **獲得ポイント**: 手札のパターンで獲得したポイント
- **手札枚数**: 現在の手札の枚数
- **山札残り**: 残りの山札枚数
- **総合スコア**: カード枚数×10 + ポイント×1

**場（2つのスロット）**:
- スロット1とスロット2のトップカードを表示
- 空のスロットには任意のカードを出せます
- カードがある場合は、同じスートまたは同じ数値のカードを出せます

**手札**:
- 現在の手札のカードを表示
- スートごとに色分けされています

**📊 山札状況**:
- 全80枚のカードを8スート×10数値の表形式で表示
- カードの状態を視覚的に確認できます
  - **🟥 赤色**: 推奨カード（次に使うべきカード）
  - **🟨 黄色**: 手札のカード
  - **薄い数値**: 使用済みカード（場に出したカード）
  - **空欄**: 山札に含まれないカード（初期の10枚除外）
  - **通常**: 山札に残っているカード

### 3. 戦略の選択

**サイドバーで戦略を選択**:

1. **ヒューリスティック（高速）** ⚡ - 推奨
   - 柔軟性スコアに基づいて最適な手を選択
   - 即座に結果表示（<0.01秒）
   - なぜそのカードを選んだかの説明付き

2. **MCTS（精密）** 🎯
   - モンテカルロ木探索による高精度な解
   - 探索回数はサイドバーで調整可能（50-2000回）
   - より多くのカードを出せる可能性が高い

### 4. 最適解の分析

#### 🎯 自動計算機能（NEW!）

**手札を出した後、自動的に次の最適解が計算されます**:
- 手札を場に出し、山札からカードを追加すると自動的に次の最適解を計算
- 戦略を変更（ヒューリスティック⇔MCTS、または探索回数変更）すると即座に再計算
- 手動で「🔍 最適解を分析」ボタンを押す必要はありません

#### 📝 手動分析

1. **「🔍 最適解を分析」ボタンをクリック**（自動計算前や再計算したい場合）
   - 選択した戦略で最適な手を探索します
   - ヒューリスティック: 即座に結果表示
   - MCTS: 進捗バーが表示されます

2. **推奨される手が表示されます**
   - 例: "✅ 推奨: A5 をスロット2に出す"
   - ヒューリスティック戦略では詳細な説明も表示されます
   - 自動計算時は「🎯 手札が更新されました」または「🔄 戦略が変更されました」のメッセージが表示されます

3. **「▶️ この手を実行」ボタンをクリック**
   - 推奨された手を実行します
   - ターンが進み、次の状態に移行します
   - 山札からカードを追加すると、自動的に次の最適解が計算されます

### 5. サイドバー設定

**🎲 戦略選択**:

- **ヒューリスティック（高速）**: 即座に結果表示（推奨）
- **MCTS（精密）**: より精密な解を探索

**⚙️ 設定**（MCTS選択時のみ表示）:

- **MCTS探索回数**: 50-2000回
  - 少ない（50-200回）: 高速だが精度が低い
  - 中程度（300-500回）: バランスが良い（推奨）
  - 多い（1000-2000回）: 高精度だが時間がかかる

**📊 ゲーム情報**:
- シード値: ゲームの再現性のための乱数シード
- 現在のターン数

**🔄 新しいゲームを開始（ランダム）**:
- 現在のゲームをリセットして新しいゲームを開始（ランダムに10枚除外）

**🎯 除外カードを指定して開始**:
- 山札から除外する10枚のカードと初期手札5枚を手動で選択してゲームを開始
- 特定のシナリオをテストしたり、戦略を検証したりできます
- 使い方:
  1. ボタンをクリック
  2. **ステップ1**: 8スート×10数値の中から除外する10枚をチェックボックスで選択
  3. **次へ**ボタンをクリック（または「ランダムな手札で開始」を選択）
  4. **ステップ2**: 残り70枚の中から初期手札となる5枚を選択
  5. 「この設定でゲーム開始」をクリック

**📖 ゲームルール**:
- ゲームの詳細なルールを表示

### 6. 履歴の確認

ゲーム中の手の履歴を「📜 履歴」セクションで確認できます。

- 最新10手を表示
- ターン番号、カード、スロットを記録

## � 典型的なプレイフロー

### 基本的な使い方（自動計算機能を活用）

1. **ゲーム開始**
   - WebUIを起動すると自動的に新しいゲームが開始されます
   - サイドバーで「ヒューリスティック（高速）」を選択（推奨）

2. **最初の手を分析**
   - 「🔍 最適解を分析」ボタンをクリック
   - 即座に推奨される手が表示されます（例: "A5 をスロット2に出す"）
   - 説明を読んで、なぜそのカードが選ばれたかを理解

3. **手を実行**
   - 「▶️ この手を実行」ボタンをクリック
   - カードが場に出され、手札追加ダイアログが表示されます

4. **手札を追加**
   - 山札から1枚を選択して「✅ このカードを手札に追加」をクリック
   - **自動的に次の最適解が計算されます**（ボタンを押す必要なし！）

5. **ゲーム続行**
   - 推奨される手が自動的に表示されるので、「▶️ この手を実行」を繰り返します
   - 出せるカードがなくなるまでプレイ

### 戦略を比較したい場合

1. **ヒューリスティック戦略でプレイ開始**
   - 推奨される手を確認（例: "A5 をスロット2"）

2. **戦略を切り替え**
   - サイドバーで「MCTS（精密）」を選択
   - **自動的に再計算**されます（ボタンを押す必要なし！）

3. **異なる推奨を比較**
   - MCTSの推奨を確認（例: "A3 をスロット1"）
   - 両方の戦略を比較して、どちらを採用するか判断

4. **戦略を戻す**
   - 「ヒューリスティック（高速）」に戻すと、また即座に再計算されます

### 特定のシナリオをテストしたい場合

1. **除外カード指定モードで開始**
   - サイドバーの「🎯 除外カードを指定して開始」をクリック

2. **除外カード10枚を選択**
   - テストしたいシナリオに応じて、特定のカードを除外

3. **初期手札5枚を選択**
   - 検証したい初期手札を設定

4. **ゲーム開始**
   - 設定した条件でゲームが開始され、最適解が自動的に計算されます

## �🎯 プレイのヒント

### 戦略の選び方

**ヒューリスティック戦略（推奨）**:

- **メリット**: 即座に結果表示、説明付き、実用的な性能
- **デメリット**: MCTS戦略より最適性はやや劣る
- **使用場面**: 通常のプレイ、学習目的、リアルタイム分析

**MCTS戦略**:

- **メリット**: より高精度な解、最大カード枚数が多い
- **デメリット**: 時間がかかる（1-30秒/手）
- **使用場面**: ベストスコアを目指す、重要な局面

### 最適な戦略

1. **カード枚数の最大化を優先**
   - ゲームの目標は、できるだけ多くのカードを場に出すこと
   - ポイントは次点の目標

2. **ヒューリスティック戦略の理解**
   - 柔軟性スコア: 残りの山札のカードとの接続可能性
   - 低い柔軟性のカードから優先的にプレイ
   - 高い柔軟性のカードは後で使う余地を残す

3. **MCTS探索回数の調整**（MCTS戦略使用時）
   - 序盤: 300-500回で十分
   - 中盤以降: 500-1000回で精度向上
   - 重要な局面: 1000-2000回でより慎重に

4. **パターンを意識**
   - 手札が特定のパターンになるとポイント獲得
   - ただし、カード枚数の方が重要

### パフォーマンス比較

**実測データ（100ゲーム平均）**:

- **ランダム戦略**: 平均6.47枚（ベースライン）
- **ヒューリスティック戦略**: 平均7.70枚（**+19.0%改善**、0.002秒/手）
- **MCTS戦略**: 平均17.8枚（**+178%改善**、1-30秒/手）

詳細は [PERFORMANCE_EVALUATION.md](PERFORMANCE_EVALUATION.md) を参照

## 🔧 トラブルシューティング

### WebUIが起動しない

```powershell
# 依存関係を再インストール
uv sync

# Streamlitを直接実行
uv run streamlit run app.py --server.headless=true
```

### ポートが使用中

別のポートで起動：

```powershell
uv run streamlit run app.py --server.port=8502
```

### アプリが遅い

- MCTS探索回数を減らす（200-300回）
- ブラウザのキャッシュをクリア

## 📝 技術詳細

### MCTSアルゴリズム

1. **選択 (Selection)**: UCB1スコアで最も有望なノードを選択
2. **展開 (Expansion)**: 新しい子ノードを追加
3. **シミュレーション (Simulation)**: ランダムプレイアウトで結果を取得
4. **逆伝播 (Backpropagation)**: 結果をルートまで伝播

### 評価関数

```
スコア = (場に出したカード枚数 × 10) + (獲得ポイント × 1)
```

## 🎮 ゲームルール詳細

### カード構成
- 8種類のスート (A-H)
- 各スート1-10の数値
- 合計80枚 → ランダムに10枚除外 → 70枚使用

### プレイルール

**カードを出せる条件**:
- スロットが空: 任意のカード
- スロットにカードあり:
  - **同じスート** または **同じ数値**

**ゲームの流れ**:
1. 手札から場にカードを出す
2. 山札から1枚引く
3. 繰り返す
4. 出せるカードがなくなったら終了

### 特別なポイント

手札が以下のパターンになると自動でポイント獲得：

| パターン | ポイント | 例 |
|---------|---------|-----|
| 4枚同じ数値 | 1pt | A5, B5, C5, D5 |
| 5枚連番 | 2pt | A3, B4, C5, D6, E7 |
| 5枚同じ数値 | 5pt | A5, B5, C5, D5, E5 |
| 5枚同じスート連番 | 50pt | A3, A4, A5, A6, A7 |

### ゲーム目標

**優先度**:
1. **場に出したカード枚数を最大化**（最優先）
2. 特別なポイントを最大化（次点）

## 📊 統計情報

WebUI上部に表示される統計：
- **ターン数**: ゲーム開始からのターン数
- **場に出したカード**: 成功した手の回数
- **獲得ポイント**: パターンマッチで得たポイント合計
- **手札枚数**: 現在の手札のカード数
- **山札残り**: まだ引かれていないカードの枚数
- **総合スコア**: 最終評価スコア

## 🎉 楽しみ方

1. **挑戦**: できるだけ多くのカードを出すことを目指す
2. **実験**: 異なるMCTS探索回数で結果を比較
3. **学習**: MCTSの推奨を見て戦略を学ぶ
4. **比較**: 複数回プレイして最高記録を目指す

---

**開発**: twin-cool-emulator
**アルゴリズム**: Monte Carlo Tree Search (MCTS)
**フレームワーク**: Streamlit
