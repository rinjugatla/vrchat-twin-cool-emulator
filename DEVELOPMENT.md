# 開発ドキュメント

## 開発状況

### ステップ 1: 開発環境の構築 ✅ 完了

- [x] プロジェクト初期化（uv）
- [x] 依存関係の設定（numpy, streamlit）
- [x] MVCモデルに基づくフォルダ構造の構築
- [x] 基本クラスの実装とテスト

#### 実装済みクラス

| クラス | ファイル | 説明 | テスト |
|--------|---------|------|--------|
| `Suit` | `src/models/suit.py` | 8種類のスートを表すEnum | - |
| `Card` | `src/models/card.py` | カードクラス（スート+数値1-10） | ✅ 7テスト |
| `Deck` | `src/models/deck.py` | 山札クラス（80枚→10枚除外→70枚） | ✅ 6テスト |
| `Hand` | `src/models/hand.py` | 手札クラス | ✅ 7テスト |
| `FieldSlot` | `src/models/field_slot.py` | スロット（カードの山）クラス | ✅ 4テスト |
| `Field` | `src/models/field.py` | 場クラス（2つのスロット） | ✅ 6テスト |
| `PointCalculator` | `src/models/point_calculator.py` | ポイント計算ロジック | ✅ 11テスト |

**ステップ1 テスト数**: 41個 / 全て通過 ✅

### ステップ 2: ゲームロジックの実装 ✅ 完了

#### 実装済みクラス

| クラス | ファイル | 説明 | テスト |
|--------|---------|------|--------|
| `MoveValidator` | `src/controllers/move_validator.py` | 合法手判定ロジック | ✅ 12テスト |
| `GameState` | `src/controllers/game_state.py` | ゲーム状態管理 | ✅ 8テスト |
| `Game` | `src/controllers/game.py` | ゲーム全体のフロー制御 | ✅ 10テスト |

**ステップ2 テスト数**: 30個 / 全て通過 ✅

#### 実装機能

1. ✅ **合法手判定** - 同じスートまたは同じ数値のカードを出せる
2. ✅ **ゲーム状態管理** - 手札、場、山札、ポイントを管理
3. ✅ **ランダムシミュレーション** - ゲームを自動でプレイ
4. ✅ **ゲーム終了判定** - 出せるカードがなくなったら終了
5. ✅ **統計情報収集** - 複数回のシミュレーション結果を分析

#### パフォーマンス（ランダム戦略）

- **平均カード枚数**: 6.4枚 / 70枚
- **平均ポイント**: 0.1ポイント
- **ターン数**: 平均6.4ターン

### ステップ 3: 最適解探索アルゴリズムの実装 ✅ 完了

#### 実装済みクラス

| クラス | ファイル | 説明 | テスト |
|--------|---------|------|--------|
| `Evaluator` | `src/controllers/evaluator.py` | ゲーム結果の評価関数 | ✅ 11テスト |
| `MCTSNode` | `src/controllers/mcts_node.py` | MCTS木のノード（UCB1） | ✅ 12テスト |
| `MCTSEngine` | `src/controllers/mcts_engine.py` | MCTS 4フェーズアルゴリズム | ✅ 10テスト |
| `MCTSStrategy` | `src/controllers/mcts_strategy.py` | MCTS戦略のユーザーAPI | ✅ 10テスト |

**ステップ3 テスト数**: 43個 / 全て通過 ✅
**総テスト数**: 114個 / 全て通過 ✅

#### アルゴリズム詳細

**モンテカルロ木探索（MCTS）**を採用：

1. ✅ **選択 (Selection)** - UCB1スコアで最も有望なノードを選択
   - UCB1 = 平均報酬 + C × √(ln(親の訪問数) / ノードの訪問数)
   - 探索重み C = 1.41 (√2)

2. ✅ **展開 (Expansion)** - 新しい子ノードを追加

3. ✅ **シミュレーション (Simulation)** - ランダムプレイアウトで結果を取得

4. ✅ **逆伝播 (Backpropagation)** - 結果をルートまで伝播

#### 評価関数

```
スコア = (場に出したカード枚数 × 10) + (獲得ポイント × 1)
```

**優先度**:
1. カード枚数の最大化（最優先）
2. ポイントの最大化（次点）

#### パフォーマンス（MCTS戦略 vs ランダム戦略）

**ベンチマーク設定**: 20ゲーム、500反復/手

| 指標 | ランダム | MCTS | 改善度 |
|------|---------|------|--------|
| **平均カード枚数** | 6.40枚 | **17.80枚** | **+178.1%** ✅ |
| **最大カード枚数** | 16枚 | **50枚** | **+212.5%** |
| **平均ポイント** | 0.10pt | 0.10pt | +0.0% |
| **最大ポイント** | 2pt | 2pt | - |

**結論**: MCTSは**大幅な改善**を達成！ 🎉

#### 実装機能

1. ✅ **評価関数** - カード枚数とポイントを総合評価
2. ✅ **UCB1探索** - 探索と活用のバランス
3. ✅ **MCTSアルゴリズム** - 4フェーズの探索サイクル
4. ✅ **戦略API** - ユーザー向けの高レベルインターフェース
5. ✅ **パフォーマンス比較** - ランダムとMCTSの統計比較
6. ✅ **再現性保証** - シード値による結果の再現性

### ステップ 4: WebUIアプリケーションの実装 ✅ 完了

#### 実装ファイル

| ファイル | 説明 | テスト |
|---------|------|--------|
| `app.py` | Streamlit WebUIアプリケーション | - |
| `WEBUI_GUIDE.md` | WebUI使用方法ドキュメント | - |

**ステップ4追加ファイル**: 2個

#### 実装機能

1. ✅ **ゲーム状態表示** - 手札、場、山札、統計情報
2. ✅ **最適解分析** - MCTS戦略による次の手の推奨
3. ✅ **インタラクティブプレイ** - ボタンクリックで手を実行
4. ✅ **設定調整** - MCTS探索回数の調整（50-2000回）
5. ✅ **履歴管理** - プレイした手の履歴表示
6. ✅ **ゲームリセット** - 新しいゲームの開始
7. ✅ **視覚的表現** - カードの色分け、スロット状態の表示
8. ✅ **統計情報** - リアルタイムのスコア計算

#### WebUI機能詳細

**画面構成**:
- **ヘッダー**: タイトルと説明
- **統計パネル**: ターン数、カード枚数、ポイント、スコア
- **場の表示**: 2つのスロットのトップカード
- **手札の表示**: 現在の手札（色分け表示）
- **最適解パネル**: MCTS推奨手と実行ボタン
- **履歴**: プレイした手の記録

**サイドバー**:
- MCTS探索回数の調整
- ゲーム情報（シード、ターン）
- 新しいゲーム開始ボタン
- ルール説明

#### 起動方法

```powershell
uv run streamlit run app.py
```

ブラウザで http://localhost:8501 にアクセス

**総テスト数**: 115個 / 全て通過 ✅

## コーディング規約

### ファイル命名規則

- **ファイル名**: スネークケース（例: `point_calculator.py`）
- **クラス名**: パスカルケース（例: `PointCalculator`）
- **関数/変数名**: スネークケース（例: `calculate_points`）

### プロジェクト構造規則

1. **1クラス1ファイル**の原則を守る
2. **ファイル名とクラス名を一致**させる
   - 例: `PointCalculator`クラス → `point_calculator.py`
3. **MVCモデル**に基づく配置
   - Models: `src/models/` - データとビジネスロジック
   - Controllers: `src/controllers/` - ゲームフロー制御
   - Views: `src/views/` - UI層（Streamlit）

### テスト規約

- **関数ごと**にテストケースを作成
- テストファイル名: `test_<モジュール名>.py`
- テストクラス名: `Test<クラス名>`
- テストメソッド名: `test_<機能説明>`

## テスト実行コマンド

### 全テスト実行

```powershell
uv run python -m unittest discover -s tests -p "test_*.py" -v
```

### 特定のテストファイル実行

```powershell
uv run python -m unittest tests.test_card -v
```

### 特定のテストクラス実行

```powershell
uv run python -m unittest tests.test_card.TestCard -v
```

### 特定のテストメソッド実行

```powershell
uv run python -m unittest tests.test_card.TestCard.test_card_creation_valid -v
```

## 開発フロー

1. **機能設計** - 実装するクラス/メソッドを設計
2. **テストコード作成** - テストケースを先に作成（TDD）
3. **実装** - 機能を実装
4. **テスト実行** - テストが通ることを確認
5. **リファクタリング** - コードを最適化
6. **ドキュメント更新** - このファイルとREADMEを更新

## 変更履歴

### 2025-10-13

#### ステップ1完了
- 開発環境構築、基本クラス実装
- MVCモデルに基づくフォルダ構造に変更
- `points.py` → `point_calculator.py`にリネーム
- 全41テスト通過確認
- ドキュメント整備

#### ステップ2完了
- ゲームロジック層の実装（MoveValidator, GameState, Game）
- 合法手判定機能の実装
- ランダムシミュレーション機能の実装
- 全30テスト追加・通過確認（総計71テスト）
- main.pyにシミュレーションデモ追加
- ドキュメント更新

#### リファクタリング: 1クラス1ファイル原則の徹底
- `card.py`から`Suit`を分離 → `suit.py`作成
- `field.py`から`Slot`を分離 → `field_slot.py`作成、`FieldSlot`にリネーム
- 全テストのインポートパス更新
- 全70テスト通過確認
